<!DOCTYPE html>
<html lang = "en">
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="css.css" />
        
    </head>
    <body>
        <div id = "container">
            <h1>Platformer</h1>
            <canvas class = "gameCanvas" id="canvas" >
                Your browser does not support the HTML5 canvas tag.
            </canvas>
            
            <button style.display = "block" id = "startButton" class = "start" onClick="init()">Start</button>
        </div>
        
    </body>
</html>

<script>
canvas = document.getElementById("canvas")
context = canvas.getContext('2d')
var startButton = document.getElementById("startButton")
let movement;
window.onload = init
pixelBelow = []
playerX = 500
playerY = 660
playerWidth = 40
playerHeight = 100
velocity = 10
floorColour = 'green'
floorHeight = 50
onGround = null

const friction = 1

controllerIndex = null;
let leftPressed = false
let rightPressed = false
let aPressed = false
function init(){

    startButton.style.display ="none" // hides button, to show use 'block' instead of none
    canvas.width = window.innerWidth
    canvas.height = window.innerHeight
    rightBoundary = canvas.width - playerWidth

draw()
}

    window.addEventListener("resize",init)
    window.addEventListener("gamepadconnected", (event)=> {
    controllerIndex = event.gamepad.index
    console.log('connected')
})

window.addEventListener("gamepaddisconnected", (event)=> {
    controllerIndex = null
})
function draw(){
    //console.log(pixelBelow)
    gameloop()
}

function gameloop(){
    clearScreen()
    drawPlayer()
    controllerInput()
    updatePlayer()
    requestAnimationFrame(draw)
    }
    
function controllerInput(){
    if(controllerIndex !== null){
        gamepad = navigator.getGamepads()[controllerIndex]
        console.log(gamepad)
        buttons = gamepad.buttons
        aPressed = buttons[0].pressed //a
        axes = gamepad.axes

        rightStick = gamepad.axes[2,3] // 2: horizontal, 3: vertical
        leftRightValue = gamepad.axes[0] //left stick || 0: horizontal, 1: vertical
        const stickDeadZone = 0.4

        if (leftRightValue >= stickDeadZone){
            rightPressed = true
        } else if (leftRightValue <= -stickDeadZone){
            leftPressed = true
        }
        
    }
}

function updatePlayer(pixelBelow){
    var pixelBelow = context.getImageData(playerX,playerY + 101,1,1)
    if(aPressed){
        jump(pixelBelow)
        //playerY = playerY - velocity //insert suvat/gravity/jump function
    }
    if(playerX !== 0){
    if(leftPressed){
        playerX = playerX - velocity
        leftPressed = false
    }}
    if(playerX < rightBoundary){
    if(rightPressed){
        playerX = playerX + velocity
        rightPressed = false
    }
    }
}

function clearScreen(){
    context.fillStyle = '#4CC1FF' //background
    context.fillRect(0,0, canvas.width, canvas.height)
    context.fillStyle = floorColour //creating floor
    context.fillRect(0,canvas.height-80,canvas.width,floorHeight)
}

function drawPlayer(){
    context.fillStyle = 'white'   //creating player
    context.fillRect(playerX,playerY,playerWidth,playerHeight)
    
}



document.addEventListener('keydown', (event) =>{
    switch(event.keyCode){
        case 65: //a
            movement = "left"
            playerX = playerX -8
        break;

        case 68: //d
            movement = "right"
            playerX = playerX + 8
        break;

        case 32: //spacebar
            yvector = -15
            
            setTimeout(jump,20)
            
        break;

    }
}
)   

function jump(pixelBelow){
    alert(pixelBelow)
    if(pixelBelow[1] == 255){
        onGround = true
    }
    if(pixelBelow[1] != 255){
        alert("can't jump")
        playerJump = true
        

    } else if(onGround == true && playerJump == false){
        alert("jump")
        yvector = 4
        playerY -= velocity
    }
    
    

}


</script>